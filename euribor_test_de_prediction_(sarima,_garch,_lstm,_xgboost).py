# -*- coding: utf-8 -*-
"""euribor test de prediction (sarima, garch, lstm, xgboost).ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OxRZs6-zR1h60BzVy2zQj3Sfck3Xo4nZ
"""

!pip install arch
!pip install tqdm
!pip install xgboost
!pip install tensorflow
!pip install keras

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf
from statsmodels.tsa.statespace.sarimax import SARIMAX
import arch
from arch import arch_model
from tqdm import tqdm
from sklearn.metrics import mean_squared_error, mean_absolute_error
from google.colab import files
from statsmodels.tsa.stattools import adfuller
from scipy import stats
from statsmodels.stats.diagnostic import het_arch, acorr_ljungbox
from sklearn.model_selection import train_test_split
from xgboost import XGBRegressor
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense

files.upload()

df = pd.read_excel('EURIBOR.xlsx', header=None)
df=df.copy()
df.head()

df.columns = ['0','1','2','3','4','Date', 'EURIBOR']
df.drop(columns=['0','1','2','3','4'], axis=1, inplace= True)
df.head()

df['Date']=pd.to_datetime(df['Date'], format = '%Y-%m-%d')
df.index=df['Date']
df=df.resample('10D').mean()
df.drop(columns=['Date'], axis=1, inplace= True)
df.head()

df.isna().sum()

plt.figure(figsize=(20,10))
plt.plot(df, c='black', label='EURIBOR')
plt.legend()
plt.title('Evolution of EURIBOR according time')
plt.grid()
plt.show()

def plot_acf_pacf(df):
  acf = plot_acf(df)
  plt.show()
  pacf = plot_pacf(df)
  plt.show()

plot_acf_pacf(df)

adf_result = adfuller(df['EURIBOR'])
print('ADF Statistic:', adf_result[0])
print('p-value:', adf_result[1])

first_order_diff = df['EURIBOR'].diff(1).dropna()
plot_acf_pacf(first_order_diff)

adf_result = adfuller(first_order_diff)
print('ADF Statistic:', adf_result[0])
print('p-value:', adf_result[1])

second_order_diff = df['EURIBOR'].diff(2).dropna()
plot_acf_pacf(second_order_diff)

adf_result = adfuller(second_order_diff)
print('ADF Statistic:', adf_result[0])
print('p-value:', adf_result[1])

adf_result

second_order_diff.plot()

train_window_size = 5 * 50
horizon = 1 * 50

step = 10
results=[]
for i in tqdm(range(0, len(df) - train_window_size - horizon + 1, step)):
  train_data = df.iloc[i:i+train_window_size]
  test_data = df.iloc[i+train_window_size:i+train_window_size+horizon]
  try:
    sarima_model = SARIMAX(train_data, order=(1,2,1), seasonal_order=(1,1,1,25), enforce_stationarity=False, enforce_invertibility=False)
    sarima_results = sarima_model.fit(disp=False)
    sarima_predictions = sarima_results.predict(start=test_data.index[0], end=test_data.index[-1])
    sarima_rmse = np.sqrt(mean_squared_error(test_data, sarima_predictions))
    sarima_mae = mean_absolute_error(test_data, sarima_predictions)
    results.append({'start':train_data.index[0], 'end':test_data.index[-1], 'sarima_rmse':sarima_rmse, 'sarima_mae':sarima_mae, 'residuals': sarima_results.resid})
  except Exception as e:
    print(f"Error processing window starting at index {i}: {e}")

residuals_test = sarima_results.resid
ljung_box_test = acorr_ljungbox(residuals_test, lags = [10, 20, 30], return_df=True)
print(ljung_box_test)

arch_test = het_arch(residuals_test, maxlag=10)
print(arch_test)

for entry in tqdm(results):
  try:
    residuals = entry['residuals']
    garch_model = arch_model(residuals, vol='GARCH', p=1, q=1, dist='t')
    garch_results = garch_model.fit(disp='off')
    garch_forecast = garch_results.forecast(horizon=horizon, reindex=False)
    sigma_forecast = np.sqrt(garch_forecast.variance.values[-1,:])
    entry['garch_sigma_forecast'] = sigma_forecast
  except Exception as e:
    print(f"Error processing window starting at index {i}: {e}")
    entry ['garch_sigma_forecast'] = np.nan

std_residuals = garch_results.std_resid
ljung_box_garch = accor_ljungbox(std_residuals, lags = [10, 20, 30], return_df=True)
print(ljung_box_garch)